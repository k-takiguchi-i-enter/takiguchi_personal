name: Terraform IC Pipeline

on:
  push:
    branches:
      - main
      - 'add_*'
      - 'delete_*'
    paths:
      - 'terraform/env/*.tfvars'
      - 'applications/**'

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ap-northeast-1

jobs:
  apply_add:
    if: startsWith(github.ref, 'refs/heads/add_')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Terraform
        run: |
          sudo apt-get update && sudo apt-get install -y gnupg lsb-release software-properties-common
          curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -
          sudo apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
          sudo apt-get update && sudo apt-get install -y terraform

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.ROLE_ARN_PRD }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform apply for add
        run: |
          cd terraform/
          terraform init -backend-config=./env/prod.backend.tfvars
          terraform apply -auto-approve -var-file=./env/prod.tfvars -target=module.cloudfront.aws_cloudfront_function.function
          terraform apply -auto-approve -var-file=./env/prod.tfvars

  apply_delete:
    if: startsWith(github.ref, 'refs/heads/delete_')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Terraform
        run: |
          sudo apt-get update && sudo apt-get install -y gnupg lsb-release software-properties-common
          curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -
          sudo apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
          sudo apt-get update && sudo apt-get install -y terraform

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.ROLE_ARN_PRD }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform apply for delete
        run: |
          cd terraform/
          terraform init -backend-config=./env/prod.backend.tfvars
          terraform apply -auto-approve -var-file=./env/prod.tfvars -target=module.cloudfront.aws_cloudfront_distribution.contents
          terraform apply -auto-approve -var-file=./env/prod.tfvars

  applications_deploy:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs: [apply_add, apply_delete]
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.ROLE_ARN_PRD }}
          aws-region: ${{ env.AWS_REGION }}

      - name: S3 sync applications/
        run: |
          aws s3 sync --exact-timestamps applications/ s3://${{ secrets.S3_BUCKET_NAME_PRD }}/applications/ --delete